name: Destroy EKS Only

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy-eks" to confirm'
        required: true

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: order-processing-eks-dev

jobs:
  destroy-eks:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'destroy-eks'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # Delete Helm deployment first
    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }} || true

    - name: Install Helm
      uses: azure/setup-helm@v3

    - name: Uninstall Helm chart
      run: |
        helm uninstall eks-analytics || true

    # Destroy only EKS resources
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init
      run: |
        cd terraform
        terraform init

    - name: Terraform Destroy EKS Only
      run: |
        cd terraform
        terraform destroy -auto-approve \
          -target=aws_eks_cluster.main \
          -target=aws_eks_node_group.main \
          -target=aws_iam_role.eks_cluster_role \
          -target=aws_iam_role.eks_node_role \
          -target=aws_iam_role_policy_attachment.eks_cluster_policy \
          -target=aws_iam_role_policy_attachment.eks_worker_node_policy \
          -target=aws_iam_role_policy_attachment.eks_cni_policy \
          -target=aws_iam_role_policy_attachment.eks_container_registry_policy \
          -target=aws_iam_role_policy.eks_node_additional_policy \
          -target=aws_vpc.eks_vpc \
          -target=aws_subnet.eks_subnet \
          -target=aws_internet_gateway.eks_igw \
          -target=aws_route_table.eks_route_table \
          -target=aws_route_table_association.eks_rta \
          -var="sns_email=${{ secrets.SNS_EMAIL }}"

    - name: Verify
      run: |
        echo "âœ… EKS destroyed. Lambda and other services remain intact."
